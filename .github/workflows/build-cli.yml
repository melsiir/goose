# Reusable workflow that builds the CLI for multiple platforms
# Used by:
#  - release.yml
#  - canary.yml

on:
  workflow_call:
    inputs:
      version:
        required: false
        default: ""
        type: string
      ref:
        type: string
        required: false
        default: ""

name: "Reusable workflow to build CLI"

jobs:
  build-cli:
    name: Build CLI
    runs-on: ${{ matrix.build-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # =====================
          # Linux (glibc)
          # =====================
          - os: linux
            architecture: x86_64
            target: x86_64-unknown-linux-gnu
            build-on: ubuntu-latest
            use-cross: true
            cc: gcc-10

          - os: linux
            architecture: aarch64
            target: aarch64-unknown-linux-gnu
            build-on: ubuntu-latest
            use-cross: true
            cc: gcc-10

          # =====================
          # macOS
          # =====================
          - os: macos
            architecture: x86_64
            target: x86_64-apple-darwin
            build-on: macos-latest
            use-cross: true

          - os: macos
            architecture: aarch64
            target: aarch64-apple-darwin
            build-on: macos-latest
            use-cross: true

          # =====================
          # Windows (GNU)
          # =====================
          - os: windows
            architecture: x86_64
            target: x86_64-pc-windows-gnu
            build-on: ubuntu-latest
            use-docker: true

          # =====================
          # Termux / Android
          # =====================
          - os: android
            architecture: aarch64
            target: aarch64-linux-android
            build-on: ubuntu-latest
            use-android: true

    steps:
      # ---------------------
      # Checkout
      # ---------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # ---------------------
      # Version override
      # ---------------------
      - name: Update version in Cargo.toml
        if: ${{ inputs.version != '' }}
        run: |
          sed -i.bak 's/^version = ".*"/version = "'${{ inputs.version }}'"/' Cargo.toml
          rm -f Cargo.toml.bak

      # ---------------------
      # Install cross (Linux/macOS)
      # ---------------------
      - name: Install cross
        if: matrix.use-cross
        run: |
          source ./bin/activate-hermit
          cargo install cross --git https://github.com/cross-rs/cross

      # ---------------------
      # Cache Rust
      # ---------------------
      - name: Cache Cargo artifacts
        if: matrix.use-cross || matrix.use-docker
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      # =====================
      # Linux / macOS build
      # =====================
      - name: Build CLI (Linux / macOS)
        if: matrix.use-cross
        env:
          CC: ${{ matrix.cc || '' }}
        run: |
          source ./bin/activate-hermit
          rustup target add ${{ matrix.target }}
          cross build --release --target ${{ matrix.target }} -p goose-cli

      # =====================
      # Windows build
      # =====================
      - name: Build CLI (Windows)
        if: matrix.use-docker
        run: |
          docker run --rm \
            -v "$(pwd)":/app \
            -w /app \
            rust:latest \
            bash -c "
              set -e
              rustup target add ${{ matrix.target }}
              apt-get update
              apt-get install -y mingw-w64 protobuf-compiler cmake
              cargo build --release --target ${{ matrix.target }} -p goose-cli
            "

      # =====================
      # Android / Termux setup
      # =====================
      - name: Install Android NDK & cargo-ndk
        if: matrix.use-android
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget

          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV

          rustup target add ${{ matrix.target }}
          cargo install cargo-ndk

      # =====================
      # Android / Termux build
      # =====================
      - name: Build CLI (Termux / Android)
        if: matrix.use-android
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          cargo ndk \
            --target ${{ matrix.target }} \
            --platform 24 \
            build --release -p goose-cli

      # =====================
      # Packaging (Unix)
      # =====================
      - name: Package CLI (Linux / macOS / Android)
        if: matrix.use-cross || matrix.use-android
        run: |
          mkdir -p target/${{ matrix.target }}/release/goose-package
          cp target/${{ matrix.target }}/release/goose \
             target/${{ matrix.target }}/release/goose-package/

          cd target/${{ matrix.target }}/release
          tar -cjf goose-${{ matrix.target }}.tar.bz2 -C goose-package .
          echo "ARTIFACT=target/${{ matrix.target }}/release/goose-${{ matrix.target }}.tar.bz2" >> $GITHUB_ENV

      # =====================
      # Packaging (Windows)
      # =====================
      - name: Package CLI (Windows)
        if: matrix.use-docker
        run: |
          mkdir -p target/${{ matrix.target }}/release/goose-package
          cp target/${{ matrix.target }}/release/goose.exe \
             target/${{ matrix.target }}/release/goose-package/

          cd target/${{ matrix.target }}/release
          zip -r goose-${{ matrix.target }}.zip goose-package
          echo "ARTIFACT=target/${{ matrix.target }}/release/goose-${{ matrix.target }}.zip" >> $GITHUB_ENV

      # ---------------------
      # Upload artifact
      # ---------------------
      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: goose-${{ matrix.target }}
          path: ${{ env.ARTIFACT }}
